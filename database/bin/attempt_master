#!/bin/bash
# attempt to become the Postgres master

CURRENT_MASTER=`etcdctl --no-sync -C $ETCD get /deis/database/master`
echo "DEBUG: etcd host is $ETCD"
echo "DEBUG: Current master is $CURRENT_MASTER"

if [[ -z "$CURRENT_MASTER" ]]; then
  echo 'DEBUG: No current master!'
  # let's become master!
  if etcdctl --no-sync -C $ETCD set /deis/database/master $HOST --ttl $ETCD_TTL --swap-with-value false >/dev/null; then
    echo 'DEBUG: We master now!'
    exit 0
  else
    echo 'DEBUG: Failed to swap us for master'
    exit 1
  fi
elif [[ "$CURRENT_MASTER" == "$HOST" ]]; then
  # we need to refresh our ownership of the key...
  echo 'DEBUG: Refreshing our master dominance'
  if etcdctl --no-sync -C $ETCD set /deis/database/master $HOST --ttl $ETCD_TTL --swap-with-value "$HOST" >/dev/null; then
    echo 'DEBUG: We are still the master!'
    exit 0
  else
    echo 'DEBUG: We had an issue refreshing our key...'
    exit 1
  fi
fi

# else, return false
echo 'DEBUG: Still a slave... :('
exit 1
